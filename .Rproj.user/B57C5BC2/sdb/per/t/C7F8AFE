{
    "collab_server" : "",
    "contents" : "pacman::p_load(tidyverse, xml2, rvest, lubridate, stringr, ggplot2, hexbin, grid, RCurl, jpeg)\n\n# cbs base_url 'http://www.cbssports.com/'\n\n\n# CBS Team Mapping --------------------------------------------------------\n\ncbsTeamMapping <- function() { \n    doc <- read_html('http://www.cbssports.com/college-basketball/teams/')\n    team_nodes <- html_nodes(doc, 'td a')\n    output <- lapply(team_nodes, function(x) { \n        team_name <- xml_text(x)\n        team_abbreviation <- xml_attr(x, 'href') %>% gsub('.*page/', '', .) %>% gsub('/.*', '', .)\n        team_nickname <- xml_attr(x, 'href') %>% gsub('.*/', '', .)\n        c(team_name=team_name, team_abbreviation=team_abbreviation, team_nickname=team_nickname)\n    })\n    plyr::ldply(output) %>% tbl_df()\n}\n\ncbs_team_mapping <- cbsTeamMapping()\n\ncbs_unc <- filter(cbs_team_mapping, team_abbreviation=='UNC')\n\n\n# CBS Schedule Mapping ----------------------------------------------------\nhttr::BROWSE('http://www.cbssports.com/collegebasketball/teams/schedule/UNC/north-carolina-tar-heels')\n\ncbsScheduleMapping <- function(team_abbreviation, team_nickname) {\n    doc <- read_html(paste('http://www.cbssports.com/collegebasketball/teams/schedule', team_abbreviation, team_nickname, sep='/'))\n    output <- html_table(doc)[[3]] %>% tbl_df()\n    names(output) <- output[3, ] %>% tolower() %>% gsub(' / ', '_', .)\n    output <- output[4:nrow(output), ]\n}\n\n# Get game_recap links.\ndoc <- read_html('http://www.cbssports.com/collegebasketball/teams/schedule/UNC/north-carolina-tar-heels')\n\n# doc <- read_html('http://www.cbssports.com/collegebasketball/teams/roster/UNC/north-carolina-tar-heels')\n# html_nodes(doc, '[class=\"data\"]')\ngame_recaps <- html_nodes(doc, 'body') %>% html_children %>% html_nodes('td a') %>% html_attr('href')\ngame_recaps <- game_recaps[str_detect(game_recaps, 'recap')] %>% paste0('http://www.cbssports.com', .)\ngame_recaps <- gsub('/recap/', '/live/', game_recaps)\n\ndocs <- lapply(game_recaps, read_html)\n\n\n# TODO: Generate game links\n'http://www.cbssports.com/collegebasketball/gametracker/playbyplay/NCAAB_20161111_UNC@TULANE'\n'http://www.cbssports.com/collegebasketball/gametracker/playbyplay/NCAAB_20161111_BROWN@CINCY'\nunc_schedule <- cbsScheduleMapping(cbs_unc$team_abbreviation, cbs_unc$team_nickname)\nunc_schedule <- unc_schedule %>% mutate(date=ifelse(grepl('Nov|Dec', date), paste(date, '2016', sep=', '), paste(date, '2017', sep=', '))) %>% \n    mutate(date=mdy(date) %>% as.character() %>% gsub('\\\\-', '', .)) %>% \n    mutate(opponent_name=gsub('@|vs. ', '', opponent) %>% gsub('St\\\\.', 'State', .) %>% gsub('Va\\\\.', 'Virginia', .))\n\n\n\nleft_join(unc_schedule, cbs_team_mapping, by=c('opponent_name' = 'team_name')) %>% View()\n          \n\nbase_url <- 'http://www.cbssports.com/collegebasketball/gametracker/playbyplay/NCAAB'\n\n\n\n'http://www.cbssports.com/collegebasketball/gametracker/playbyplay/NCAAB_20161111_UNC@TULANE'\n'http://www.cbssports.com/collegebasketball/gametracker/playbyplay/NCAAB_20161111_BROWN@CINCY'\n\n# Format for game data.\n'http://www.cbssports.com/collegebasketball/gametracker/playbyplay/NCAAB_', game_date, away_team_abbreviation, '@', home_team_abbreviation\n\n\n\n# CBS Shot Location Data --------------------------------------------------\n\ncbsShotLocationData <- function(doc) { \n    # doc <- read_html('http://www.cbssports.com/collegebasketball/gametracker/live/NCAAB_20161217_UK@UNC')\n    # doc <- read_html('http://www.cbssports.com/collegebasketball/gametracker/live/NCAAB_20170121_UNC@BC#') # this has tons of shot data\n    # \n    # http://sports.cbsimg.net/js/CBSi/app/LiveChartNcaab-v005.js\n    # This works for scoring data! \n    my_nodes <- html_nodes(doc, '[class=\"liveChart\"]') %>% html_children()\n    if (length(my_nodes) > 0 ) { \n        my_text <- my_nodes[5] %>% html_text(trim=TRUE)\n        my_text <- my_text %>% gsub('\\\\s+', '', .) %>% gsub('.*shotData:', '', .) %>% gsub('~', '\\n', .) %>% \n            gsub(',awayScoringData.*', '', .) %>% gsub('\"', '', .)\n        scoring_data <- str_split(my_text, '\\n') %>% data.frame(stringsAsFactors=F) %>% tbl_df()\n        names(scoring_data) <- 'V1'\n        \n        scoring_data <- separate(scoring_data, V1, c('team', 'time', 'period', 'player_id', 'shot_type', 'result',\n                                                     'loc_x', 'loc_y', 'distance'), sep = ',')    \n        \n        scoring_data$loc_x <- as.numeric(scoring_data$loc_x)\n        scoring_data$loc_y <- as.numeric(scoring_data$loc_y) %>% abs()\n        scoring_data$distance <- as.numeric(scoring_data$distance)\n        return(scoring_data)\n    }\n}\n\nshots <- list()\nfor(i in 1:length(docs)) { \n    cat(i, '\\n')\n    shots[[i]] <- cbsShotLocationData(docs[[i]])\n}\n\nshots <- lapply(docs, cbsShotLocationData)\n\nscoring_data <- plyr::ldply(shots) %>% tbl_df()\n\n# scoring_data$result <- as.numeric(scoring_data$result)\n\n# TODO: figure out column names, better way than writing to .txt file?  \n# Columns\n# v1: away==0, home==1 \n# v2: time remaining \n# v3: period/half\n# v4: player_id \n# v5: shot_type\n# v6: result 0==missed, 1==made \n# v7: x_position negative is left side of court.\n# v8: y_position distance from center court in feet.\n# v9: distance\n\n\n\nscoring_data %>% filter(grepl('11|12', shot_type))\nscoring_data %>% filter(!grepl('11|12', shot_type))\n\nscoring_data %>% filter(!grepl('11|12', shot_type)) %>% \n    ggplot(., aes(loc_x, -loc_y+42, colour=result)) + \n    geom_count()\n\n# Joel Berry\nscoring_data %>% filter(player_id=='2152684' & !grepl('11|12', shot_type))\nscoring_data %>% filter(player_id=='2152684' & !grepl('11|12', shot_type)) %>% \n    ggplot(., aes(-loc_y+42, loc_x, colour=as.factor(result))) + geom_point()\n    \nscoring_data %>% filter(player_id=='2152684' & !grepl('11|12', shot_type)) %>% \n    ggplot(., aes(-loc_x, -loc_y+42, colour=as.factor(result))) + \n    geom_point() +\n\nscoring_data %>% filter(!grepl('11|12', shot_type)) %>% \n    ggplot(., aes(-loc_x, -loc_y+42, colour=as.factor(result))) + geom_point()\n\nscoring_data %>% filter(!grepl('11|12', shot_type) & result=='1') %>% \n    ggplot(., aes(-loc_x, -loc_y+42)) + \n    stat_binhex(colour='gray', alpha=0.7) + \n    scale_fill_gradientn(colours=c('yellow', 'orange', 'red'))\n\n# Info on locking size of graph to court.\n# https://thedatagame.com.au/2015/09/27/how-to-create-nba-shot-charts-in-r/ \n\n\n# half court image\ncourtImg.URL <- \"https://thedatagame.files.wordpress.com/2016/03/nba_court.jpg\"\ncourt <- rasterGrob(readJPEG(getURLContent(courtImg.URL)),\n                    width=unit(1,\"npc\"), height=unit(1,\"npc\"))\n\ncourtImg.URL <- \"C:/Users/jglenn.CNHIDOM/Downloads/NCAAGT2014court-lines.jpeg\"\ncourt <- rasterGrob(readJPEG(courtImg.URL), \n                    width=unit(1, 'npc'), height=unit(1, 'npc'))\n\n# scoring_data %>% filter(!grepl('11|12', shot_type)) %>% \nscoring_data %>% filter(player_id=='2152684' & !grepl('11|12', shot_type)) %>% \n    ggplot(., aes(-loc_x, -loc_y+42, colour=result, shape=result)) + \n    annotation_custom(court, -25, 25, -5, 42) +\n    geom_point() +\n    xlim(-25, 25) + \n    ylim(-0, 42) + \n    geom_rug(alpha=0.2) + \n    coord_fixed()\n\n\n# court background http://sports.cbsimg.net/images/collegebasketball/gametracker/NCAAGT2014court-bg.png\n# court lines: url('http://sports.cbsimg.net/images/collegebasketball/gametracker/NCAAGT2014court-lines.png');\n\nlibrary(png)\n'http://a.espncdn.com/redesign/assets/img/ncaab/bg-court-logo.png'\ncourt_background_url <- 'http://sports.cbsimg.net/images/collegebasketball/gametracker/NCAAGT2014court-bg.png'\ncourt_lines_url <- 'http://sports.cbsimg.net/images/collegebasketball/gametracker/NCAAGT2014court-lines.png'\n\ncourt_background <- rasterGrob(readPNG(getURLContent(court_background_url)),\n           width=unit(1,\"npc\"), height=unit(1,\"npc\"))\n\ncourt_lines <- rasterGrob(readPNG(getURLContent(court_lines_url)),\n                               width=unit(1,\"npc\"), height=unit(1,\"npc\"))\n\n\nscoring_data %>% filter(!grepl('11|12', shot_type)) %>% \n    ggplot(., aes(-loc_x, -loc_y+42, colour=as.factor(result))) + \n    annotation_custom(court_background, -25, 25, -5, 42) \n    geom_point() + \n    xlim(-25, 25) + \n    ylim(-0, 42) + \n    geom_rug(alpha=0.2) + \n    coord_fixed()\n\n    \ncourt_lines <- readPNG(\"C:/Users/jglenn.CNHIDOM/Downloads/NCAAGT2014court-lines.png\")\n    ",
    "created" : 1489606173586.000,
    "dirty" : false,
    "encoding" : "UTF-8",
    "folds" : "",
    "hash" : "2561252079",
    "id" : "C7F8AFE",
    "lastKnownWriteTime" : 1486561585,
    "last_content_update" : 1486561585,
    "path" : "~/R/ncaa-basketball/cbs.R",
    "project_path" : "cbs.R",
    "properties" : {
    },
    "relative_order" : 1,
    "source_on_save" : false,
    "source_window" : "",
    "type" : "r_source"
}